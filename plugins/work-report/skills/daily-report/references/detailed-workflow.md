# 日报工作流程详细说明

本文档包含日报生成的详细工作流程，供需要深入了解实现细节时参考。

## 模板文件

日报使用 `template.md` 作为输出格式模板，包含：
- 12字段表格结构（序号、类型、任务名称、接收时间、完成时间、预计耗时、进度、交付时间、当天耗时、总耗时、异常、AI百分比）
- 工作总结分组格式
- 总工时统计格式

字段详细规范参见 `../shared/table-fields.md`。

---

## 交互式填写模式

使用 TodoWrite 创建任务列表，逐步引导:

### 1. 收集任务基本信息
- 任务名称（自动去除类型前缀）
- 自动推断任务类型（参考 `../shared/task-type-rules.md`）
- 选择任务所属平台（有配置文件时从配置生成选项，无配置时可跳过或手动输入）
- 接收任务时间（默认今日 09:00）

### 2. 记录任务进度
- 当前进度百分比
- 预计和当天耗时
- 如果进度=100%，询问实际交付时间

### 3. 其他信息
- 是否存在异常
- AI处理百分比

### 4. 继续添加
询问是否继续添加更多任务

---

## 从现有文件导入模式

询问用户提供数据源文件路径，支持的格式:
- Markdown 列表
- JSON 格式
- CSV 文件
- 纯文本任务列表

---

## 从Git提交导入模式 (详细流程)

> 配置文件应在初始化阶段已读取完成，此处直接使用。

### 执行流程（严格按顺序）

**1. 检查初始化阶段获取的配置信息**:
- 如果第一步已成功读取配置文件且包含项目路径 → 直接进入步骤2
- 如果第一步未找到配置文件 → 进入步骤3

**2. 有配置文件时（自动执行，禁止询问用户）**:
- 直接使用初始化阶段获取的项目路径列表
- 对每个项目执行 `git -C <path> log` 获取今日提交记录
- **禁止使用 AskUserQuestion 询问项目路径**

**3. 无配置文件时**，使用 AskUserQuestion 询问:
```
问题: "未找到平台配置文件，请选择操作:"
选项:
  1. "手动输入项目路径" - 直接提供需要扫描的Git项目路径
  2. "生成配置文件" - 使用 /config-platform 命令创建配置（推荐长期使用）
```

**4. 解析提交并拆分多Issue任务**:
- 解析 Conventional Commits 格式: `type(scope): message #issue1 #issue2`
- 提取所有issue编号（正则: `#(\d+)`）
- **单issue提交**: 直接作为一个任务
- **多issue提交**: 拆分为独立任务
  - 分析commit message中的并列描述（用"、"或"和"分隔）
  - 每个issue对应一个独立任务行
  - 工时 = 原提交估算工时 / issue数量（最小0.25小时）

**5. 规范化任务描述**:
根据commit类型生成规范化描述:
- `fix` → "修复[问题描述]的问题"
- `feat` → "实现[功能描述]"
- `perf`/`refactor`/`style` → "优化[内容描述]"
- `chore`/`docs` → 保持原描述

---

## 继续昨日任务模式

1. 读取昨日日报文件
2. 识别进度 < 100% 的任务
3. 询问是否继续这些任务
4. 更新进度和累计工时

---

## 智能计算逻辑

```javascript
// 当天耗时 = 用户输入的实际工作小时数
// 总耗时计算
if (任务是新任务) {
  总耗时 = 当天耗时
} else if (任务是昨日继续) {
  总耗时 = 昨日总耗时 + 当天耗时
}

// 总工时 = sum(所有任务的当天耗时)
```

---

## 数据验证规则

1. **完整性检查**: 所有12个字段都已填写
2. **逻辑验证**: 接收时间 ≤ 完成时间，进度 0-100%
3. **格式验证**: 时间格式 YYYY-MM-DD HH:MM

---

## 输出格式示例

### 有平台配置时

```markdown
## 2025年10月30日工作内容总结

### 新增功能开发
1. [网页] 用户登录功能开发
2. [微信小程序] 订单管理页面 (进度: 80%)

### 交互优化
1. [网页] 优化表单交互体验

### Bug修复
1. [微信小程序] 修复表情显示问题

**总计工作时长**: 8.0小时
```

### 无平台配置时

```markdown
## 2025年10月30日工作内容总结

### 新增功能开发
1. 用户登录功能开发
2. 订单管理页面 (进度: 80%)

### 交互优化
1. 优化表单交互体验

### Bug修复
1. 修复表情显示问题

**总计工作时长**: 8.0小时
```

### 格式说明

- 标题: `## YYYY年MM月DD日工作内容总结`
- 按分类分组: 新增功能开发、交互优化、Bug修复
- 有平台配置时格式: `[平台] 任务名称 (进度: X%)`
- 无平台配置时格式: `任务名称 (进度: X%)`（省略平台标签）
- **不显示类型标签（如 [页面]、[操作] 等）**
- 添加总工时: `**总计工作时长**: X.X小时`
- 保存文件: `日报_YYYY-MM-DD.md`
